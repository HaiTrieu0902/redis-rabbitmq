# Microservices Authentication & User Management

H·ªá th·ªëng microservices v·ªõi Authentication service v√† User service s·ª≠ d·ª•ng NestJS, PostgreSQL, Redis, v√† OAuth2.0 (Google, GitHub, Microsoft MSAL).

## üèóÔ∏è Ki·∫øn tr√∫c

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend (3000)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ HTTP Requests
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Authentication     ‚îÇ  ‚îÇ User Service   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Service (3001)     ‚îÇ  ‚îÇ (3002)         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ                    ‚îÇ  ‚îÇ                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - Google OAuth     ‚îÇ  ‚îÇ - User CRUD    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - GitHub OAuth     ‚îÇ  ‚îÇ - Profile Mgmt ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - MSAL OAuth       ‚îÇ  ‚îÇ - Caching      ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - JWT Generation   ‚îÇ  ‚îÇ                ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ           ‚îÇ                      ‚îÇ          ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ                      ‚îÇ                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                             ‚îÇ
        ‚ñº                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Redis (6379)  ‚îÇ            ‚îÇ PostgreSQL     ‚îÇ
‚îÇ               ‚îÇ            ‚îÇ (5432)         ‚îÇ
‚îÇ - Session     ‚îÇ            ‚îÇ                ‚îÇ
‚îÇ - Cache       ‚îÇ            ‚îÇ - users        ‚îÇ
‚îÇ - Pub/Sub     ‚îÇ            ‚îÇ - user_identity‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ T√≠nh nƒÉng

### Authentication Service (Port 3001)
- ‚úÖ Google OAuth 2.0 authentication
- ‚úÖ GitHub OAuth authentication  
- ‚úÖ Microsoft Azure AD (MSAL) authentication
- ‚úÖ JWT token generation & validation
- ‚úÖ Refresh token mechanism
- ‚úÖ Token blacklist (logout)
- ‚úÖ Redis session management
- ‚úÖ User creation/update via OAuth

### User Service (Port 3002)
- ‚úÖ Get user profile (with Redis caching)
- ‚úÖ Update user information
- ‚úÖ Delete user account
- ‚úÖ List all users (paginated)
- ‚úÖ Real-time sync v·ªõi Auth service qua Redis Pub/Sub
- ‚úÖ JWT authentication middleware

### Redis Integration
- ‚úÖ Session management
- ‚úÖ Token caching
- ‚úÖ Token blacklist
- ‚úÖ Pub/Sub messaging gi·ªØa services
- ‚úÖ User data caching (1 hour TTL)

## üì¶ C√†i ƒë·∫∑t

### 1. Prerequisites
```bash
# ƒê·∫£m b·∫£o ƒë√£ c√†i ƒë·∫∑t:
- Node.js >= 18
- PostgreSQL >= 14
- Docker (cho Redis)
```

### 2. Ch·∫°y Redis
```bash
cd d:\redis-mq
docker-compose up -d
```

### 3. Setup Database
```bash
# Import SQL schema
psql -U postgres -d vuihoi -f sql.sql
```

### 4. Install Dependencies

**Authentication Service:**
```bash
cd authenication
npm install
```

**User Service:**
```bash
cd user
npm install
```

## ‚öôÔ∏è Configuration

### Authentication Service (.env)
```env
DATABASE_URL=postgresql://postgres:040202005173@localhost:5432/vuihoi
REDIS_HOST=localhost
REDIS_PORT=6379

JWT_SECRET=your-super-secret-jwt-key-change-in-production
JWT_EXPIRES_IN=15m
JWT_REFRESH_SECRET=your-super-secret-refresh-jwt-key-change-in-production
JWT_REFRESH_EXPIRES_IN=7d

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REDIRECT_URI=http://localhost:3001/auth/callback/google

# GitHub OAuth
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
GITHUB_REDIRECT_URI=http://localhost:3001/auth/callback/github

# Microsoft MSAL
APP_AZURE_CLIENT_ID=your-azure-client-id
APP_AZURE_TENANT_ID=your-azure-tenant-id
APP_AZURE_REDIRECT_URI=http://localhost:3001/auth/msal/callback
AZURE_CLIENT_SECRET=your-azure-client-secret

PORT=3001
```

### User Service (.env)
```env
DATABASE_URL=postgresql://postgres:040202005173@localhost:5432/vuihoi
REDIS_HOST=localhost
REDIS_PORT=6379

JWT_SECRET=your-super-secret-jwt-key-change-in-production
PORT=3002
```

## üéØ Ch·∫°y Services

### Development Mode

**Terminal 1 - Authentication Service:**
```bash
cd authenication
npm run start:dev
```

**Terminal 2 - User Service:**
```bash
cd user
npm run start:dev
```

## üìù API Documentation

### Authentication Service (http://localhost:3001)

#### 1. Google OAuth Login
```
GET /auth/google
```
Redirect user ƒë·∫øn Google login page.

```
GET /auth/callback/google
```
Google callback URL, returns tokens.

#### 2. GitHub OAuth Login
```
GET /auth/github
```
Redirect user ƒë·∫øn GitHub login page.

```
GET /auth/callback/github
```
GitHub callback URL, returns tokens.

#### 3. Microsoft MSAL Login
```
GET /auth/msal
```
Redirect user ƒë·∫øn Microsoft login page.

```
GET /auth/msal/callback?code={code}
```
Microsoft callback URL, returns tokens.

#### 4. Refresh Token
```http
POST /auth/refresh
Content-Type: application/json

{
  "refresh_token": "your-refresh-token"
}
```

Response:
```json
{
  "access_token": "new-access-token",
  "refresh_token": "new-refresh-token",
  "expires_in": 900,
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "User Name",
    "avatar_url": "https://..."
  }
}
```

#### 5. Logout
```http
POST /auth/logout
Authorization: Bearer {access_token}
```

#### 6. Get Current User
```http
GET /auth/me
Authorization: Bearer {access_token}
```

### User Service (http://localhost:3002)

#### 1. Get My Profile
```http
GET /users/me
Authorization: Bearer {access_token}
```

Response:
```json
{
  "id": "uuid",
  "email": "user@example.com",
  "name": "User Name",
  "avatar_url": "https://...",
  "created_at": "2025-01-01T00:00:00Z",
  "updated_at": "2025-01-01T00:00:00Z"
}
```

#### 2. Update My Profile
```http
PUT /users/me
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "name": "New Name",
  "avatar_url": "https://new-avatar.com/image.jpg"
}
```

#### 3. Get User By ID
```http
GET /users/{userId}
Authorization: Bearer {access_token}
```

#### 4. Get All Users (Paginated)
```http
GET /users?limit=20&offset=0
Authorization: Bearer {access_token}
```

#### 5. Delete My Account
```http
DELETE /users/me
Authorization: Bearer {access_token}
```

## üîê Authentication Flow

### OAuth Flow (Google/GitHub/MSAL)
```
1. Frontend ‚Üí GET /auth/google
2. Redirect to Google OAuth consent screen
3. User approves
4. Google ‚Üí GET /auth/callback/google?code=xxx
5. Auth Service:
   - Exchange code for Google tokens
   - Get user info from Google
   - Create/update user in database
   - Create user identity record
   - Generate JWT tokens
   - Cache in Redis
   - Publish event to Redis
6. Redirect to frontend with tokens
7. Frontend stores tokens
8. Frontend uses access_token for API calls
```

### JWT Flow
```
1. Frontend ‚Üí API Request with Authorization: Bearer {token}
2. Service validates JWT signature
3. Service checks if token is blacklisted (Redis)
4. Service extracts userId from token
5. Service processes request
6. Return response
```

### Refresh Token Flow
```
1. Frontend ‚Üí POST /auth/refresh with refresh_token
2. Auth Service validates refresh token
3. Check if token is blacklisted
4. Generate new access_token & refresh_token
5. Return new tokens
```

## üîÑ Microservices Communication

### Redis Pub/Sub Events

**Event: user:updated**
```json
{
  "userId": "uuid",
  "email": "user@example.com",
  "name": "User Name",
  "avatar_url": "https://...",
  "timestamp": "2025-01-01T00:00:00Z"
}
```

**Event: user:deleted**
```json
{
  "userId": "uuid",
  "timestamp": "2025-01-01T00:00:00Z"
}
```

## üß™ Testing

### Test OAuth Login (Browser)
1. M·ªü browser
2. Navigate to `http://localhost:3001/auth/google`
3. Login v·ªõi Google account
4. S·∫Ω ƒë∆∞·ª£c redirect v·ªÅ v·ªõi tokens

### Test API v·ªõi cURL

**Get user profile:**
```bash
curl -X GET http://localhost:3002/users/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

**Update profile:**
```bash
curl -X PUT http://localhost:3002/users/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "New Name"}'
```

## üìä Database Schema

```sql
-- Users table
users (
  id UUID PRIMARY KEY,
  name VARCHAR(255),
  email VARCHAR(255) UNIQUE,
  avatar_url TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
)

-- User identities (OAuth providers)
user_identity (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  provider VARCHAR(50), -- 'google', 'github', 'msal'
  provider_user_id VARCHAR(255),
  access_token TEXT,
  refresh_token TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  UNIQUE(provider, provider_user_id)
)
```

## üé® Tech Stack

- **Framework:** NestJS
- **Database:** PostgreSQL with TypeORM
- **Cache/Queue:** Redis (ioredis)
- **Authentication:** Passport.js + JWT
- **OAuth Providers:** 
  - Google (passport-google-oauth20)
  - GitHub (passport-github2)
  - Microsoft Azure AD (@azure/msal-node)
- **Validation:** class-validator, class-transformer

## üîí Security Best Practices

1. ‚úÖ JWT secrets ƒë∆∞·ª£c l∆∞u trong environment variables
2. ‚úÖ Passwords kh√¥ng ƒë∆∞·ª£c l∆∞u (ch·ªâ d√πng OAuth)
3. ‚úÖ Tokens c√≥ expiration time
4. ‚úÖ Refresh tokens cho long-term sessions
5. ‚úÖ Token blacklist khi logout
6. ‚úÖ CORS configured properly
7. ‚úÖ Input validation v·ªõi class-validator
8. ‚úÖ SQL injection protection v·ªõi TypeORM

## üêõ Troubleshooting

### Redis connection failed
```bash
# Check if Redis is running
docker ps

# Restart Redis
docker-compose restart redis
```

### Database connection error
```bash
# Check PostgreSQL is running
psql -U postgres -c "SELECT 1"

# Check DATABASE_URL in .env files
```

### OAuth redirect mismatch
- ƒê·∫£m b·∫£o redirect URIs trong .env match v·ªõi Google/GitHub/Azure console
- Google Console: https://console.cloud.google.com/
- GitHub Apps: https://github.com/settings/developers
- Azure Portal: https://portal.azure.com/

## üìà Monitoring

### Check Services Health
```bash
# Auth service
curl http://localhost:3001/auth/health

# User service
curl http://localhost:3002/users/health
```

### Redis CLI
```bash
docker exec -it redis redis-cli
> KEYS *
> GET user:{userId}
```

## üöÄ Production Deployment

1. Set `synchronize: false` trong TypeORM config
2. Use production database
3. Set strong JWT secrets
4. Configure Redis with password
5. Use HTTPS for all endpoints
6. Set proper CORS origins
7. Enable rate limiting
8. Add logging & monitoring (Winston, Sentry)
9. Use environment-specific .env files

## üìÑ License

MIT

## üë®‚Äçüíª Author

Microservices Authentication & User Management System
